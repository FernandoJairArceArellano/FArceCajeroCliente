<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://ultra.net.nz/thyemeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title layout:fragment="title">Usuarios</title>
</head>

<body>
    <section layout:fragment="content">
        <div class="container mt-4 mb-4 t-5">

        </div>
        <div class="table-responsive">
            <div class="text-center mb-4">
                <h2 id="titulo-usuarios">Usuarios registrados</h2>
            </div>
            <table class="table table-striped table-bordered text-center fs-5 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th class="w-auto">ID</th>
                        <th class="w-auto">Nombre</th>
                        <th class="w-auto">Nombre de Usuario</th>
                        <th class="w-auto">Correo</th>
                        <th class="w-auto">Fecha de Nacimiento</th>
                        <th class="w-auto">Telefono</th>
                        <th class="w-auto">Celular</th>
                        <th class="w-auto">Status</th>
                        <th class="w-auto">Saldo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="usuario : ${usuarios}" class="align-middle">
                        <td th:text="${usuario.idUsuario}"></td>
                        <td th:text="|${usuario.nombre} ${usuario.apellidoPaterno} ${usuario.apellidoMaterno}|"></td>
                        <td th:text="${usuario.userName}"></td>
                        <td th:text="${usuario.email}"></td>
                        <td>
                            <p>Fecha de nacimiento: <span
                                    th:text="${#dates.format(usuario.fNacimiento, 'dd/MM/yyyy')}"></span></p>
                        </td>
                        <td th:text="${usuario.telefono}"></td>
                        <td th:text="${usuario.nCelular}"></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span th:text="${usuario.Status == 1 ? 'Activo' : 'Inactivo'}" class="badge text-center"
                                    th:classappend="${usuario.Status == 1 ? ' bg-success' : ' bg-secondary'}"
                                    style="min-width: 100px; font-size: 1rem; padding: 0.4rem 0.6rem; border-radius: 0.5rem;">
                                </span>
                            </div>
                        </td>
                        <td th:text="|$${usuario.saldo}|"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script>
            $(document).ready(function () {
                $('.status-switch').on('change', function () {
                    const checkbox = $(this);
                    const IdUsuario = checkbox.data('id');
                    const status = checkbox.is(':checked') ? 1 : 0;

                    $.ajax({
                        url: 'http://localhost:8081/usuarioapi/v1/updateStatus',
                        method: 'POST',
                        data: {
                            IdUsuario: IdUsuario,
                            Status: status
                        },
                        success: function (response) {
                            if (response === 'OK') {
                                const label = checkbox.closest('.form-check').find('.status-label');
                                label.text(status === 1 ? 'Activo' : 'Inactivo');
                            } else {
                                alert('Error al actualizar el estado');
                                checkbox.prop('checked', !checkbox.is(':checked')); // revertir cambio si falla
                            }
                        },
                        error: function () {
                            alert('Ocurrió un error en el servidor');
                            checkbox.prop('checked', !checkbox.is(':checked')); // revertir cambio si falla
                        }
                    });
                });
            });

            // fetch("http://localhost:8081/auth/status", {
            //     credentials: "include"
            // })
            //     .then(response => {
            //         if (!response.ok) {
            //             window.location.href = "/Usuario";
            //         }
            //     })
            //     .catch(error => {
            //         console.error("Error al verificar autenticación:", error);
            //         window.location.href = "/Usuario";
            //     });
        </script>
    </section>
</body>

</html>